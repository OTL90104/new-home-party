<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å±…è½æˆé›†è³‡æ´¾å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
        }

        .hero-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* é ç±¤æ¨£å¼ */
        .nav-tabs .nav-link {
            color: #555;
        }

        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #0d6efd;
        }

        /* æ›¸æ«ƒäº’å‹•å€ */
        .shelf-container {
            position: relative;
            width: 100%;
            margin-bottom: 30px;
        }

        .shelf-main-img {
            width: 100%;
            max-width: 600px;
            display: block;
            margin: 0 auto;
            border-radius: 8px;
        }

        .parts-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .part-card {
            position: relative;
            width: 180px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .part-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .part-img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            padding: 10px;
        }

        /* é–ƒçˆå‹•ç•« */
        .blinking {
            animation: border-blink 2s infinite;
            border: 2px solid #ffc107;
        }

        @keyframes border-blink {
            0% {
                border-color: #ffc107;
                box-shadow: 0 0 5px #ffc107;
            }

            50% {
                border-color: transparent;
                box-shadow: none;
            }

            100% {
                border-color: #ffc107;
                box-shadow: 0 0 5px #ffc107;
            }
        }

        .completed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.05);
            pointer-events: none;
        }

        .progress-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 1.2rem;
        }
    </style>
</head>

<body>

    <div class="container py-4">
        <div class="text-center mb-4">
            <h1>ğŸ  Welcome to Our New Home</h1>
            <p class="text-muted">æ–°å®¶é›†è³‡ & æš–æˆ¿æ´¾å°é‚€è«‹</p>
        </div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="home-tab" data-bs-toggle="tab"
                    data-bs-target="#home" type="button">æ´»å‹•èªªæ˜</button></li>
            <li class="nav-item"><button class="nav-link" id="progress-tab" data-bs-toggle="tab"
                    data-bs-target="#progress" type="button">é›†è³‡é€²åº¦</button></li>
            <li class="nav-item"><button class="nav-link" id="attendance-tab" data-bs-toggle="tab"
                    data-bs-target="#attendance" type="button">å‡ºå¸­ç¢ºèª</button></li>
            <li class="nav-item"><button class="nav-link" id="mylist-tab" data-bs-toggle="tab" data-bs-target="#mylist"
                    type="button">æˆ‘çš„è´ŠåŠ©æ¸…å–®</button></li>
        </ul>

        <div class="tab-content" id="myTabContent">

            <div class="tab-pane fade show active" id="home">
                <div class="hero-section" id="login-section">
                    <h3 class="text-center mb-4">ğŸ‘‹ æ­¡è¿ï¼è«‹å…ˆç™»å…¥</h3>
                    <p class="text-center">ç‚ºäº†æ–¹ä¾¿ç®¡ç†è´ŠåŠ©ç´€éŒ„ï¼Œè«‹å…ˆä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
                    <div id="g_id_onload"
                        data-client_id="393865719804-2i50c9oc93qjr41hqgi3s17n09j5jdno.apps.googleusercontent.com"
                        data-callback="handleCredentialResponse" data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin d-flex justify-content-center" data-type="standard" data-size="large"
                        data-theme="outline" data-text="sign_in_with"></div>
                </div>

                <div class="hero-section" id="name-input-section" style="display:none;">
                    <h4 class="text-center mb-3">âœï¸ è«‹å¡«å¯«æ‚¨çš„ç¨±å‘¼</h4>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="userNameInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„åå­—">
                    </div>
                    <button class="btn btn-primary w-100" id="btnSaveName">ç¢ºèª</button>
                </div>

                <div class="hero-section" id="welcome-section" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="m-0">ğŸ‰ æ­¡è¿ï¼Œ<span id="displayUserName"></span>ï¼</h3>
                        <button id="btnLogout" class="btn btn-outline-danger btn-sm">ç™»å‡º</button>
                    </div>
                    <h3>é—œæ–¼é€™æ¬¡çš„é›†è³‡...</h3>
                        <p>å—¨å¤§å®¶ï¼å› ç‚ºæˆ‘è¦æ¬æ–°å®¶ï¼Œå¾ˆå¤šæœ‹å‹åœ¨å•é€ä»€éº¼ç¦®ç‰©æ¯”è¼ƒé©åˆã€‚å…¶å¯¦æˆ‘å€‘ç›®å‰æœ€éœ€è¦çš„æ˜¯ä¸€å€‹å¯¦ç”¨çš„æ”¶ç´å±¤æ¶ï¼Œå¸Œæœ›èƒ½é€éé€™å€‹æœ‰è¶£çš„æ–¹å¼ï¼Œ<strong>é›†çµå¤§å®¶çš„å¿ƒæ„</strong>ï¼Œè®“æˆ‘å€‘ä¸€èµ·ã€Œæ‹¼ã€å‡ºé€™å€‹å®¶çš„ä¸€éƒ¨ä»½ï¼
                        </p>
                        <hr>
                        <h5>ğŸ’¡ å¦‚ä½•åƒèˆ‡ï¼Ÿ</h5>
                        <ul>
                            <li>è«‹åˆ‡æ›åˆ° <strong>ã€Œé›†è³‡é€²åº¦ã€</strong> é ç±¤ã€‚</li>
                            <li>ä½ å¯ä»¥çœ‹åˆ°å±¤æ¶è¢«æ‹†è§£æˆå¥½å¹¾å€‹éƒ¨åˆ†ï¼ˆæŠ½å±œã€å±¤æ¿ã€æ”¯æ¶ç­‰ï¼‰ã€‚</li>
                            <li>é»é¸é–ƒçˆçš„å€å¡Šï¼ˆä»£è¡¨é‚„æ²’é›†æ»¿ï¼‰ï¼Œå¯ä»¥è¼¸å…¥ä½ æƒ³è´ŠåŠ©çš„é‡‘é¡ã€‚</li>
                            <li><strong>å®‰å¿ƒä¿è­‰ï¼š</strong> ä½ çš„è´ŠåŠ©é‡‘é¡åªæœ‰æˆ‘å€‘å¾Œå°çœ‹å¾—åˆ°ï¼Œå‰å°åªæœƒé¡¯ç¤ºè©²å“é …ç›®å‰çš„ç™¾åˆ†æ¯”é€²åº¦ã€‚</li>
                        </ul>
                </div>
            </div>

            <div class="tab-pane fade" id="progress">
                <div class="hero-section text-center">
                    <h5>âœ¨ æœ€çµ‚ç›®æ¨™ï¼šå¤¢æƒ³å±¤æ¶ âœ¨</h5>
                    <img src="images/shelf_complete.jpg" alt="å±¤æ¶å®Œæˆåœ–" class="shelf-main-img">
                    <p class="mt-2 text-muted">é€™æ˜¯æˆ‘å€‘æ‹¼æ¹Šå®Œæˆå¾ŒæœŸå¾…çš„æ¨£å­ï¼</p>
                </div>

                <div class="hero-section text-center">
                    <h5>ğŸ“¦ å±¤æ¶çµæ§‹åˆ†è§£</h5>
                    <img src="images/shelf_parts.jpg" alt="å±¤æ¶åˆ†è§£åœ–" class="shelf-main-img"
                        style="max-width: 80%; margin-bottom: 20px;">
                </div>

                <div class="hero-section">
                    <h5 class="text-center mb-3">ğŸ‘‡ é»æ“Šä¸‹æ–¹é›¶ä»¶é–‹å§‹è´ŠåŠ© ğŸ‘‡</h5>
                    <p class="text-center text-small text-muted">é–ƒçˆä»£è¡¨å°šæœªé”æ¨™ï¼Œé»æ“Šå³å¯è´ŠåŠ©ï¼</p>

                    <div class="parts-grid" id="shelf-parts-container">
                        <div class="text-center w-100">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>è¼‰å…¥é›†è³‡é€²åº¦ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="attendance">
                <div class="hero-section">
                    <h4 class="mb-3">ğŸ‰ æš–æˆ¿æ´¾å°å‡ºå¸­ç¢ºèª</h4>
                    <p>æ„Ÿè¬å¤§å®¶å¹³å¸¸çš„ç…§é¡§ï¼æˆ‘å€‘è¦çµ±è¨ˆæœ€çµ‚ç”¨é¤äººæ•¸ï¼Œéº»ç…©å¤§å®¶å¹«æˆ‘å¡«å¯«ä¸€ä¸‹ã€‚</p>
                    <form id="attendanceForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">1. å‡ºå¸­æ–°å®¶æ´¾å°çš„æ™‚é–“ (å¯å¤šé¸)</label>
                            <div class="text-muted small mb-2">å‚™è¨»ï¼š2/1çš„æ™‚é–“ä¸Šå¾ˆfreeï¼Œä¸­åˆå¾…åˆ°æ™šä¸Šä¹Ÿå¯ä»¥</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="times"
                                    value="1/31 æ™šä¸Š" id="t1"><label class="form-check-label" for="t1">1/31
                                    æ™šä¸Šï¼ˆå®¶äºº/è¦ªæˆšï¼‰</label></div>
                            <hr />
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="times"
                                    value="2/1 ä¸­åˆ" id="t2"><label class="form-check-label" for="t2">2/1
                                    ä¸­åˆï¼ˆé«˜ä¸­æœ‹å‹/æ¨‚åœ˜æœ‹å‹ï¼‰</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="times"
                                    value="2/1 æ™šä¸Š" id="t3"><label class="form-check-label" for="t3">2/1
                                    æ™šä¸Šï¼ˆåœ‹ä¸­æœ‹å‹ï¼‰</label></div>
                            <hr />
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="times"
                                    value="2/7 æ™šä¸Š" id="t4"><label class="form-check-label" for="t4">2/7
                                    æ™šä¸Šï¼ˆå°å¤§é†«é™¢åŒäº‹ï¼‰</label></div>
                            <hr />
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="times"
                                    value="2/8 ä¸­åˆ" id="t5"><label class="form-check-label" for="t5">2/8 ä¸­åˆï¼ˆåŒ—é†«æœ‹å‹ï¼‰</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">2. å‡ºå¸­äººæ•¸</label>
                            <div class="row">
                                <div class="col">
                                    <label for="adults" class="form-label">å¹¾ä½å¤§äºº</label>
                                    <select class="form-select" name="adults" id="adults" required>
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <label for="kids" class="form-label">å¹¾ä½å°å­©</label>
                                    <select class="form-select" name="kids" id="kids">
                                        <option value="0" selected>0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">3. æ˜¯å¦ç”¨é¤</label>
                            <div class="text-muted small">å‚™è¨»ï¼šé¸ä¸­åˆæœ‰æä¾›åˆé¤ï¼Œé¸æ™šä¸Šæœ‰æä¾›æ™šé¤</div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="meal" value="yes" id="mealY"
                                    required>
                                <label class="form-check-label" for="mealY">æ˜¯ï¼Œæˆ‘è¦ç”¨é¤</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="meal" value="no" id="mealN">
                                <label class="form-check-label" for="mealN">å¦ï¼Œåƒé£½éå»</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">4. é£²é£Ÿç¿’æ…£</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="diet" value="è‘·" id="diet1" checked>
                                <label class="form-check-label" for="diet1">è‘·</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="diet" value="ç´ " id="diet2">
                                <label class="form-check-label" for="diet2">ç´ </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">5. æœ‰æ²’æœ‰ä»€éº¼æƒ³å°æˆ‘å€‘èªªçš„è©±?</label>
                            <textarea class="form-control" name="message" rows="3"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="btnSubmitAttendance">é€å‡ºç¢ºèª</button>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="mylist">
                <div class="hero-section">
                    <h4 class="text-center mb-4">æˆ‘çš„è´ŠåŠ©ç´€éŒ„</h4>
                    <div class="table-responsive">
                        <table id="mySponsorTable" class="table table-striped table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>æ™‚é–“</th>
                                    <th>å“é …</th>
                                    <th>é‡‘é¡</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sponsorModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalItemName">å“é …åç¨±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>ç›®æ¨™é‡‘é¡ï¼š</label> <span id="modalTarget" class="fw-bold"></span>
                    </div>
                    <div class="mb-2">
                        <label>å‰©é¤˜é‡‘é¡ï¼š</label> <span id="modalRemaining" class="fw-bold text-success"></span>
                    </div>
                    <div class="mb-3">
                        <label>ç›®å‰é€²åº¦ï¼š</label>
                        <div class="progress mt-1">
                            <div id="modalProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="modalProgressText">å·²å‹Ÿé›† $0 (0%)</small>
                    </div>

                    <hr>
                    <form id="sponsorForm">
                        <input type="hidden" id="hiddenItemId">
                        <input type="hidden" id="hiddenItemName">

                        <div class="mb-3">
                            <label class="form-label">è´ŠåŠ©é‡‘é¡</label>
                            <input type="number" class="form-control" id="sponsorAmount" required min="1"
                                placeholder="è¼¸å…¥é‡‘é¡">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmSponsor">ç¢ºèªè´ŠåŠ©</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Config
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz_rPtRsnpz9tJAquqjooSfQQ__x7G0cDWhnWZ80MwXIAKeGL1rZeUT4LzvVGNq7SIZ/exec";
        let currentUserEmail = "";
        let currentUserName = "";

        $(document).ready(function () {

            // 1. æª¢æŸ¥æ˜¯å¦å·²ç¶“ç™»å…¥é
            checkLoginStatus();

            // 2. è¼‰å…¥æ™‚æŠ“å–å•†å“è³‡æ–™
            loadShelfItems();

            // 3. å‡ºå¸­è¡¨å–®é©—è­‰èˆ‡é€å‡º
            $("#attendanceForm").validate({
                submitHandler: function (form) {
                    if (!currentUserName) {
                        Swal.fire("è«‹å…ˆç™»å…¥", "è«‹å…ˆåœ¨é¦–é ç™»å…¥ä¸¦å¡«å¯«æ‚¨çš„åå­—", "warning");
                        return;
                    }
                    const formData = {
                        action: "addAttendance",
                        name: currentUserName,
                        times: $("input[name='times']:checked").map(function () { return $(this).val(); }).get().join(", "),
                        adults: $("select[name='adults']").val(),
                        kids: $("select[name='kids']").val(),
                        meal: $("input[name='meal']:checked").val(),
                        diet: $("input[name='diet']:checked").val(),
                        message: $("textarea[name='message']").val()
                    };

                    $("#btnSubmitAttendance").prop("disabled", true).text("å‚³é€ä¸­...");

                    $.post(GAS_URL, JSON.stringify(formData))
                        .done(function (res) {
                            Swal.fire("æ„Ÿè¬å¡«å¯«!", "æœŸå¾…èˆ‡ä½ åœ¨æ–°å®¶ç›¸è¦‹!", "success");
                            $("#attendanceForm")[0].reset();
                        })
                        .fail(function () {
                            Swal.fire("Oops...", "å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
                        })
                        .always(function () {
                            $("#btnSubmitAttendance").prop("disabled", false).text("é€å‡ºç¢ºèª");
                        });
                }
            });

            // 4. ç¢ºèªè´ŠåŠ©æŒ‰éˆ•
            $("#btnConfirmSponsor").click(function () {
                if (!$("#sponsorForm").valid()) return;

                if (!currentUserEmail || !currentUserName) {
                    Swal.fire("è«‹å…ˆç™»å…¥", "è«‹å…ˆåœ¨é¦–é ç™»å…¥ä¸¦å¡«å¯«æ‚¨çš„åå­—", "warning");
                    return;
                }

                const amount = parseInt($("#sponsorAmount").val());
                const itemId = $("#hiddenItemId").val();
                const itemName = $("#hiddenItemName").val();
                const targetAmount = parseInt($("#modalTarget").data("target"));
                const currentAmount = parseInt($("#modalTarget").data("current"));
                const email = currentUserEmail;
                const name = currentUserName;

                // è¨ˆç®—å‰©é¤˜å¯è´ŠåŠ©é‡‘é¡
                const remainingAmount = targetAmount - currentAmount;

                // æª¢æŸ¥è´ŠåŠ©é‡‘é¡æ˜¯å¦è¶…éå‰©é¤˜é‡‘é¡
                if (amount > remainingAmount) {
                    Swal.fire("é‡‘é¡è¶…éä¸Šé™", `ç›®å‰å‰©é¤˜å¯è´ŠåŠ©é‡‘é¡ç‚º $${remainingAmount}ï¼Œæ‚¨è¼¸å…¥çš„é‡‘é¡è¶…éä¸Šé™`, "warning");
                    return;
                }

                const payload = {
                    action: "addSponsor",
                    email: email,
                    userName: name,
                    itemId: itemId,
                    itemName: itemName,
                    amount: amount
                };

                $("#btnConfirmSponsor").prop('disabled', true).text("è™•ç†ä¸­...");

                $.post(GAS_URL, JSON.stringify(payload))
                    .done(function (response) {
                        $('#sponsorModal').modal('hide');
                        Swal.fire("è´ŠåŠ©æˆåŠŸ!", "è¬è¬ä½ çš„å¿ƒæ„ï¼", "success");
                        loadShelfItems(); // é‡æ–°æ•´ç†é€²åº¦
                        if (currentUserEmail) loadMyList(currentUserEmail); // å¦‚æœå·²ç™»å…¥ï¼Œæ›´æ–°æ¸…å–®
                    })
                    .always(function () {
                        $("#btnConfirmSponsor").prop('disabled', false).text("ç¢ºèªè´ŠåŠ©");
                    });
            });

            // 5. å„²å­˜ä½¿ç”¨è€…åå­—
            $("#btnSaveName").click(function () {
                const userName = $("#userNameInput").val().trim();
                if (!userName) {
                    Swal.fire("è«‹å¡«å¯«åå­—", "è«‹è¼¸å…¥æ‚¨çš„ç¨±å‘¼", "warning");
                    return;
                }
                currentUserName = userName;
                
                // å°‡è³‡æ–™å­˜å…¥ LocalStorage
                localStorage.setItem("userEmail", currentUserEmail);
                localStorage.setItem("userName", currentUserName);
                
                $("#name-input-section").hide();
                $("#welcome-section").fadeIn();
                $("#displayUserName").text(userName);
                loadMyList(currentUserEmail);
            });

            // 6. ç™»å‡ºæŒ‰éˆ•
            $("#btnLogout").click(function () {
                // æ¸…é™¤æœ¬åœ°å„²å­˜
                localStorage.removeItem("userEmail");
                localStorage.removeItem("userName");
                
                // é‡ç½®è®Šæ•¸
                currentUserEmail = "";
                currentUserName = "";
                
                // ä»‹é¢å¾©åŸ
                $("#welcome-section").hide();
                $("#name-input-section").hide();
                $("#login-section").fadeIn();
                $(".g_id_signin").show();
                
                Swal.fire("å·²ç™»å‡º", "æœŸå¾…æ‚¨å†æ¬¡å›ä¾†ï¼", "info");
            });

            // 7. é˜²æ­¢è¡¨å–®æŒ‰ Enter é€ æˆé é¢é‡æ•´ï¼Œä¸¦å°‡å…¶å°å‘ã€Œç¢ºèªè´ŠåŠ©ã€æŒ‰éˆ•
            $("#sponsorForm").on("submit", function(e) {
                e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­çš„æ›é è¡Œç‚º
                $("#btnConfirmSponsor").click(); // å‡è£ä½¿ç”¨è€…æŒ‰ä¸‹äº†ã€Œç¢ºèªè´ŠåŠ©ã€æŒ‰éˆ•
            });

        }); // End Document Ready

        // --- Functions ---

        function loadShelfItems() {
            $.getJSON(GAS_URL, { action: "getItems" }, function (items) {
                const container = $("#shelf-parts-container");
                container.empty();

                items.forEach(item => {
                    const percent = Math.min(100, Math.round((item.current_amount / item.target_amount) * 100));
                    const isFull = percent >= 100;
                    const blinkClass = isFull ? "" : "blinking";
                    const pointerEvent = isFull ? "style='pointer-events:none; opacity:0.8;'" : "";
                    const displayPercent = isFull ? "å·²é¡æ»¿" : `${percent}%`;

                    const html = `
                    <div class="part-card ${blinkClass}" ${pointerEvent} 
                         data-id="${item.id}" 
                         data-name="${item.name}" 
                         data-target="${item.target_amount}" 
                         data-current="${item.current_amount}">
                        <img src="${item.image_url}" class="part-img" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                        <div class="progress-badge">${displayPercent}</div>
                        ${isFull ? '<div class="completed-overlay"></div>' : ''}
                    </div>
                `;
                    container.append(html);
                });

                // ç¶å®šé»æ“Šäº‹ä»¶
                $(".part-card").click(function () {
                    const dataset = $(this).data();
                    const percent = Math.round((dataset.current / dataset.target) * 100);

                    const remainingAmount = dataset.target - dataset.current;
                    
                    $("#modalItemName").text(dataset.name);
                    $("#hiddenItemId").val(dataset.id);
                    $("#hiddenItemName").val(dataset.name);
                    $("#modalTarget").text(`$${dataset.target}`).data("target", dataset.target).data("current", dataset.current);
                    $("#modalRemaining").text(`$${remainingAmount}`);
                    $("#modalProgressBar").css("width", percent + "%").text(percent + "%");
                    $("#modalProgressText").text(`å·²å‹Ÿé›† $${dataset.current} (${percent}%)`);
                    $("#sponsorAmount").val("").attr("max", remainingAmount).attr("placeholder", `æœ€å¤šå¯è´ŠåŠ© $${remainingAmount}`);

                    $("#sponsorModal").modal("show");
                });
            });
        }

        // Google Login Callback
        function handleCredentialResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);

            currentUserEmail = responsePayload.email;
            // æ³¨æ„ï¼šé€™è£¡ä¸å…ˆå­˜ userNameï¼Œç­‰ä½¿ç”¨è€…ç¢ºèªåå­—å¾Œæ‰å­˜

            $("#login-section").hide();
            $("#name-input-section").fadeIn();
            $("#userNameInput").val(responsePayload.name || "");
        }

        // æ–°å¢ï¼šæª¢æŸ¥ç™»å…¥ç‹€æ…‹
        function checkLoginStatus() {
            const storedEmail = localStorage.getItem("userEmail");
            const storedName = localStorage.getItem("userName");

            if (storedEmail && storedName) {
                console.log("ç™¼ç¾èˆŠçš„ç™»å…¥ç´€éŒ„ï¼Œè‡ªå‹•ç™»å…¥ä¸­...");
                // æ›´æ–°å…¨åŸŸè®Šæ•¸
                currentUserEmail = storedEmail;
                currentUserName = storedName;
                
                // æ›´æ–° UI
                $("#login-section").hide();
                $("#name-input-section").hide();
                $("#welcome-section").fadeIn();
                $("#displayUserName").text(storedName);
                
                // è¼‰å…¥æ¸…å–®
                loadMyList(storedEmail);
            }
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function loadMyList(email) {
            if ($.fn.DataTable.isDataTable('#mySponsorTable')) {
                $('#mySponsorTable').DataTable().destroy();
            }

            $.getJSON(GAS_URL, { action: "getMyList", email: email }, function (data) {
                const tbody = $("#mySponsorTable tbody");
                tbody.empty();

                data.forEach(row => {
                    const date = new Date(row.timestamp).toLocaleDateString();
                    const tr = `
                    <tr>
                        <td>${date}</td>
                        <td>${row.item_name}</td>
                        <td>$${row.amount}</td>
                        <td>
                            <button class="btn btn-sm btn-danger btn-cancel" 
                                data-id="${row.item_id}" 
                                data-amount="${row.amount}">å–æ¶ˆ</button>
                        </td>
                    </tr>
                `;
                    tbody.append(tr);
                });

                $('#mySponsorTable').DataTable({
                    "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/zh-HANT.json" }
                });

                // ç¶å®šå–æ¶ˆæŒ‰éˆ•
                $(".btn-cancel").click(function () {
                    const btn = $(this);
                    const itemId = btn.data("id");
                    const amount = btn.data("amount");

                    Swal.fire({
                        title: 'ç¢ºå®šå–æ¶ˆè´ŠåŠ©?',
                        text: "å–æ¶ˆå¾Œé‡‘é¡å°‡æœƒæ‰£é™¤",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'æ˜¯çš„ï¼Œå–æ¶ˆ!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.post(GAS_URL, JSON.stringify({
                                action: "cancelSponsor",
                                email: currentUserEmail,
                                itemId: itemId,
                                amount: amount
                            })).done(function () {
                                Swal.fire("å·²å–æ¶ˆ!", "æ‚¨çš„è´ŠåŠ©å·²å–æ¶ˆã€‚", "success");
                                loadMyList(currentUserEmail);
                                loadShelfItems(); // æ›´æ–°é€²åº¦
                            });
                        }
                    });
                });
            });
        }
    </script>

</body>

</html>
