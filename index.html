<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新居落成派對</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
        }

        .hero-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* 頁籤樣式 */
        .nav-tabs .nav-link {
            color: #555;
        }

        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #0d6efd;
        }

        /* 書櫃互動區 */
        .shelf-container {
            position: relative;
            width: 100%;
            margin-bottom: 30px;
        }

        .shelf-main-img {
            width: 100%;
            max-width: 600px;
            display: block;
            margin: 0 auto;
            border-radius: 8px;
        }

        .parts-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .part-card {
            position: relative;
            width: 180px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .part-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .part-img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            padding: 10px;
        }

        /* 閃爍動畫 */
        .blinking {
            animation: border-blink 2s infinite;
            border: 2px solid #ffc107;
        }

        @keyframes border-blink {
            0% {
                border-color: #ffc107;
                box-shadow: 0 0 5px #ffc107;
            }

            50% {
                border-color: transparent;
                box-shadow: none;
            }

            100% {
                border-color: #ffc107;
                box-shadow: 0 0 5px #ffc107;
            }
        }

        .completed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.05);
            pointer-events: none;
        }

        .progress-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 1.2rem;
        }

        /* 銀行帳戶資訊區塊樣式 */
        .bank-info-section {
            background: #f8f9fa;
            border: 2px solid #0d6efd;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .bank-info-section h5 {
            color: #0d6efd;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .account-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .account-details p {
            margin: 8px 0;
            font-size: 1.05rem;
        }

        .account-details strong {
            color: #333;
            min-width: 100px;
            display: inline-block;
        }

        .qr-code-container {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .qr-code-container img {
            max-width: 250px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
    </style>
</head>

<body>

    <div class="container py-4">
        <div class="text-center mb-4">
            <h1>🏠 Welcome to Our New Home</h1>
            <p class="text-muted">暖房派對邀請 & 書櫃共築計劃</p>
        </div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="attendance-tab" data-bs-toggle="tab"
                    data-bs-target="#attendance" type="button">出席確認</button></li>
            <li class="nav-item"><button class="nav-link" id="home-tab" data-bs-toggle="tab" data-bs-target="#home"
                    type="button">書櫃共築計劃(自由參加喔!!)</button></li>
            <li class="nav-item"><button class="nav-link" id="progress-tab" data-bs-toggle="tab"
                    data-bs-target="#progress" type="button">計劃進度</button></li>
            <li class="nav-item"><button class="nav-link" id="mylist-tab" data-bs-toggle="tab" data-bs-target="#mylist"
                    type="button">我的贊助清單</button></li>
            <li class="nav-item"><button class="nav-link" id="concert-tab" data-bs-toggle="tab"
                    data-bs-target="#concert" type="button">3.12 北醫音樂會</button></li>
        </ul>

        <div class="tab-content" id="myTabContent">

            <div class="tab-pane fade" id="home">
                <div class="hero-section">
                    <h3>關於這次的集資...</h3>
                    <p>嗨大家！因為我要搬新家，很多朋友在問送什麼禮物比較適合。因為我家這邊還有空白的牆(如下圖)，目前最需要的是一個實用的收納層架，希望能透過這個有趣的方式，<strong>集結大家的心意</strong>，讓我們一起「拼」出這個家的一部份！
                    </p>
                    <div class="text-center my-3">
                        <img src="images/empty_wall.jpg" alt="空白的牆" class="shelf-main-img" style="max-width: 500px;">
                        <p class="text-muted small mt-2">目前家裡的空白牆面</p>
                    </div>
                    <hr>
                    <h5>💡 如何參與？</h5>
                    <ul>
                        <li>請切換到 <strong>「計劃進度」</strong> 頁籤。</li>
                        <li>你可以看到層架被拆解成好幾個部分（抽屜、層板、支架等）。</li>
                        <li>點選閃爍的區塊（代表還沒集滿），可以輸入你想贊助的金額。</li>
                        <li><strong>安心保證：</strong> 你的贊助金額只有我們後台看得到，前台只會顯示該品項目前的百分比進度。</li>
                    </ul>

                    <hr>
                    <h5>🎁 贊助回饋</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">🍽️ 回饋1：美味的大餐</h6>
                                    <p class="card-text">感謝您的贊助，邀請您一起享用美味的新居派對大餐！</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">🎵 回饋2：北醫音樂會門票</h6>
                                    <p class="card-text">2026.3.12 (四) 19:30<br>北醫管絃樂團年度音樂會<br>國家音樂廳</p>
                                    <a href="https://www.opentix.life/event/2000497794253086721" target="_blank"
                                        rel="noopener" class="btn btn-sm btn-outline-primary">查看詳情</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">♻️ 回饋3：環保按壓瓶減量器</h6>
                                    <p class="card-text">錫藝之美，永續之選<br>壓少一點－按壓瓶減量器</p>
                                    <a href="https://www.zeczec.com/projects/press-less" target="_blank" rel="noopener"
                                        class="btn btn-sm btn-outline-success">查看專案</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hero-section" id="login-section">
                    <h3 class="text-center mb-4">👋 要贊助的話，請先登入</h3>
                    <p class="text-center">為了方便管理贊助紀錄，請先使用 Google 帳號登入</p>
                    <div id="g_id_onload"
                        data-client_id="393865719804-2i50c9oc93qjr41hqgi3s17n09j5jdno.apps.googleusercontent.com"
                        data-callback="handleCredentialResponse" data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin d-flex justify-content-center" data-type="standard" data-size="large"
                        data-theme="outline" data-text="sign_in_with"></div>
                </div>

                <div class="hero-section" id="name-input-section" style="display:none;">
                    <h4 class="text-center mb-3">✏️ 請填寫您的稱呼</h4>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="userNameInput" placeholder="請輸入您的名字">
                    </div>
                    <button class="btn btn-primary w-100" id="btnSaveName">確認</button>
                </div>

                <div class="hero-section" id="welcome-section" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="m-0">🎉 歡迎，<span id="displayUserName"></span>！</h3>
                        <button id="btnLogout" class="btn btn-outline-danger btn-sm">登出</button>
                    </div>
                    <p class="text-success fw-bold">您已成功登入，可以開始進行贊助囉！</p>
                </div>
            </div>

            <div class="tab-pane fade" id="progress">
                <div class="hero-section text-center">
                    <h5>✨ 最終目標：夢想層架 ✨</h5>
                    <img src="images/shelf_complete.jpg" alt="層架完成圖" class="shelf-main-img">
                    <p class="mt-2 text-muted">這是我們拼湊完成後期待的樣子！</p>
                </div>

                <div class="hero-section text-center">
                    <h5>📦 層架結構分解</h5>
                    <img src="images/shelf_parts.jpg" alt="層架分解圖" class="shelf-main-img"
                        style="max-width: 80%; margin-bottom: 20px;">
                </div>

                <div class="hero-section">
                    <h5 class="text-center mb-3">👇 點擊下方零件開始贊助 👇</h5>
                    <p class="text-center text-small text-muted">閃爍代表尚未達標，點擊即可贊助！</p>

                    <div class="parts-grid" id="shelf-parts-container">
                        <div class="text-center w-100">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>載入集資進度中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade show active" id="attendance">
                <div class="hero-section">
                    <h4 class="mb-3">🎉 暖房派對出席確認</h4>
                    <p>感謝大家平常的照顧！我們要統計最終用餐人數，麻煩大家幫我填寫一下。</p>
                    <p>新家地址：台北市信義區信義路五段150巷22弄~</p>
                                        <iframe
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d4299.240104268469!2d121.56799444121837!3d25.02675661606346!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3442abb2f279473d%3A0xf4afc3301721d167!2zMTEw5Y-w5YyX5biC5L-h5LmJ5Yy65L-h576p6Lev5LqU5q61MTUw5be3MjLlvIQx6Jmf!5e0!3m2!1szh-TW!2stw!4v1768801446323!5m2!1szh-TW!2stw"
                        width="100%" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade"></iframe>
                    <form id="attendanceForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">1. 您的名字</label>
                            <input type="text" class="form-control" name="attendeeName" id="attendeeName"
                                placeholder="請輸入您的名字" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">2. 出席新家派對的時間 (可多選)</label>
                            <div class="text-muted small mb-2">備註：2/1的時間上很free，中午待到晚上也可以</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="times"
                                    value="1/31 晚上" id="t1"><label class="form-check-label" for="t1">1/31
                                    晚上（家人/親戚）</label></div>
                            <hr />
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="times"
                                    value="2/1 中午" id="t2"><label class="form-check-label" for="t2">2/1
                                    中午（高中朋友/樂團朋友）</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="times"
                                    value="2/1 晚上" id="t3"><label class="form-check-label" for="t3">2/1
                                    晚上（國中朋友）</label></div>
                            <hr />
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="times"
                                    value="2/7 晚上" id="t4"><label class="form-check-label" for="t4">2/7
                                    晚上（台大醫院同事）</label></div>
                            <hr />
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="times"
                                    value="2/8 中午" id="t5"><label class="form-check-label" for="t5">2/8 中午（北醫朋友）</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">3. 出席人數</label>
                            <div class="row">
                                <div class="col">
                                    <label for="adults" class="form-label">幾位大人</label>
                                    <select class="form-select" name="adults" id="adults" required>
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <label for="kids" class="form-label">幾位小孩</label>
                                    <select class="form-select" name="kids" id="kids">
                                        <option value="0" selected>0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">4. 是否用餐</label>
                            <div class="text-muted small">備註：選中午有提供午餐，選晚上有提供晚餐</div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="meal" value="yes" id="mealY"
                                    required>
                                <label class="form-check-label" for="mealY">是，我要用餐</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="meal" value="no" id="mealN">
                                <label class="form-check-label" for="mealN">否，吃飽過去</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">5. 飲食習慣</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="diet" value="葷" id="diet1" checked>
                                <label class="form-check-label" for="diet1">葷</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="diet" value="素" id="diet2">
                                <label class="form-check-label" for="diet2">素</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">6. 有沒有什麼想對我們說的話?</label>
                            <textarea class="form-control" name="message" rows="3"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="btnSubmitAttendance">送出確認</button>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="mylist">
                <div class="hero-section">
                    <h4 class="text-center mb-4">我的贊助紀錄</h4>
                    <div class="table-responsive">
                        <table id="mySponsorTable" class="table table-striped table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>時間</th>
                                    <th>品項</th>
                                    <th>金額</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <!-- 銀行帳戶資訊區塊 (有贊助紀錄時才顯示) -->
                    <div id="bankInfoSection" class="bank-info-section" style="display: none;">
                        <h5>💳 匯款資訊</h5>
                        <div class="row">
                            <div class="col-md-7">
                                <div class="account-details">
                                    <p><strong>銀行：</strong>824 連線商業銀行</p>
                                    <p><strong>分行：</strong>總行 6880</p>
                                    <p><strong>帳號：</strong>111010169900</p>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="qr-code-container">
                                    <p class="fw-bold mb-2">掃描 QR Code 匯款</p>
                                    <img src="images/account_qr.jpg" alt="帳戶 QR Code"
                                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <p class="text-muted small" style="display: none;">QR Code 圖片載入失敗</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="concert">
                <div class="hero-section">
                    <div class="text-center mb-4">
                        <h3>🎵 《Eroica》臺北醫學大學管絃樂團年度音樂會</h3>
                        <p class="text-muted">Taipei Medical University Orchestra Annual Concert</p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">📅 演出資訊</h5>
                                    <p class="mb-2"><strong>日期時間：</strong>2026年3月12日 (四) 19:30</p>
                                    <p class="mb-2"><strong>演出地點：</strong>國家音樂廳<br>臺北市中正區中山南路21-1號</p>
                                    <p class="mb-0"><strong>主辦單位：</strong>臺北醫學大學管絃樂團</p>
                                    <p class="mb-0"><strong>類別：</strong>音樂 │ <strong>分級：</strong>普遍級</p>
                                    <p class="mb-0"><strong>票價：</strong>$300 / $500 / $800 / $1,000 / $1,200 / $1,500
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">🎟️ 購票資訊</h5>
                                    <p class="mb-3">提供電子票、電腦配位及自行選位服務</p>
                                    <a href="https://www.opentix.life/event/2000497794253086721" target="_blank"
                                        rel="noopener" class="btn btn-primary btn-lg w-100 mb-2">前往 OPENTIX 購票</a>
                                    <div class="alert alert-info mb-0" role="alert">
                                        <small>
                                            <strong>優惠資訊：</strong><br>
                                            • 2026/02/06前早鳥票7折<br>
                                            • 學生票9折（需出示證件）<br>
                                            • 65歲以上長者5折<br>
                                            • 身心障礙者及陪同者5折
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">🎼 演出曲目</h5>
                            <p>在忙碌的醫學訓練日常裡，臺北醫學大學管絃樂團以對音樂的初心，期待學生團員在演奏中與人分享喜悅、帶來溫暖。今年我們以全貝多芬節目為主軸，展開一段關於光與自由的旅程。</p>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <strong>貝多芬：《雷歐諾拉序曲》第三號</strong><br>
                                    <small class="text-muted">L.v. Beethoven: Leonore Overture No.3</small>
                                </li>
                                <li class="list-group-item">
                                    <strong>貝多芬：《莫德林格舞曲》十一首 WoO 17</strong><br>
                                    <small class="text-muted">L.v. Beethoven: 11 Mödlinger Tänze, WoO 17</small>
                                </li>
                                <li class="list-group-item">
                                    <strong>貝多芬：第三號交響曲《英雄》</strong><br>
                                    <small class="text-muted">L.v. Beethoven: Symphony No.3, "Eroica"</small>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">🎻 指揮暨音樂總監</h5>
                                    <h6 class="text-primary">廖嘉弘</h6>
                                    <p class="small">指揮家、小提琴家廖嘉弘，國立維也納音樂院演奏家文憑及藝術碩士，現為國立臺灣師範大學音樂學院院長暨音樂系專任教授。</p>
                                    <blockquote class="blockquote small">
                                        <p class="mb-1">"他富維也納樂派風格，音樂性敏感細膩，具備了廣泛深刻的音樂詮釋力"</p>
                                        <footer class="blockquote-footer">維也納音樂季權威樂評家 M. Ruedenauer</footer>
                                    </blockquote>
                                    <blockquote class="blockquote small">
                                        <p class="mb-1">"演出深具大將風範，是一位音樂風格充滿自信兼具東方神韻的音樂家"</p>
                                        <footer class="blockquote-footer">華盛頓郵報</footer>
                                    </blockquote>
                                    <p class="small mb-0">精湛琴藝榮獲國內外肯定，演奏足跡遍及歐洲、美洲、澳洲及日本，並常受邀於世界各地大師班講座。</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">🎹 助理指揮暨指導教師</h5>
                                    <h6 class="text-primary">章皓維</h6>
                                    <p class="small">
                                        國立臺灣師範大學音樂系指揮碩士，鋼琴與管絃樂指揮雙主修，為國內少數深入鋼琴、室內樂、管絃暨歌劇曲目的青年指揮暨鋼琴家。現就讀國立臺灣師範大學音樂系博士班。
                                    </p>
                                    <p class="small"><strong>得獎經歷：</strong></p>
                                    <ul class="small mb-2">
                                        <li>行天宮菁音獎鋼琴比賽得主</li>
                                        <li>YAMAHA全國鋼琴大賽得主</li>
                                        <li>豐泰室內樂大賽得主</li>
                                        <li>臺灣國際雙鋼琴與聯彈音樂大賽得主</li>
                                    </ul>
                                    <p class="small mb-0">致力於推廣音樂藝術與樂團教育，現任新北市交響樂團助理指揮、之間樂團音樂總監、臺北醫學大學管弦樂團副指揮等職。</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">🎺 關於臺北醫學大學管絃樂團</h5>
                            <p>臺北醫學大學管絃樂團成立於民國68年，儘管醫學領域課業繁重，樂團仍保持每週至少一次的例行團練，在現任指揮暨音樂總監廖嘉弘教授的帶領之下，每年均定期在校內外各場合舉辦演出，頗受好評及熱烈迴響。
                            </p>
                            <p class="mb-0">作為醫學大學的一份子，我們不僅僅要能夠治療身體的疾病，更要能夠療癒心靈。透過音樂，我們希望能夠帶給社會更多的溫暖與希望。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sponsorModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalItemName">品項名稱</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>目標金額：</label> <span id="modalTarget" class="fw-bold"></span>
                    </div>
                    <div class="mb-2">
                        <label>剩餘金額：</label> <span id="modalRemaining" class="fw-bold text-success"></span>
                    </div>
                    <div class="mb-3">
                        <label>目前進度：</label>
                        <div class="progress mt-1">
                            <div id="modalProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="modalProgressText">已募集 $0 (0%)</small>
                    </div>

                    <hr>
                    <form id="sponsorForm">
                        <input type="hidden" id="hiddenItemId">
                        <input type="hidden" id="hiddenItemName">

                        <div class="mb-3">
                            <label class="form-label">贊助金額</label>
                            <input type="number" class="form-control" id="sponsorAmount" required min="1"
                                placeholder="輸入金額">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmSponsor">確認贊助</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Config
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz_rPtRsnpz9tJAquqjooSfQQ__x7G0cDWhnWZ80MwXIAKeGL1rZeUT4LzvVGNq7SIZ/exec";
        let currentUserEmail = "";
        let currentUserName = "";

        $(document).ready(function () {

            // 1. 檢查是否已經登入過
            checkLoginStatus();

            // 2. 載入時抓取商品資料
            loadShelfItems();

            // 3. 出席表單驗證與送出
            $("#attendanceForm").validate({
                submitHandler: function (form) {
                    const attendeeName = $("#attendeeName").val().trim();
                    if (!attendeeName) {
                        Swal.fire("請填寫名字", "請輸入您的名字", "warning");
                        return;
                    }
                    const formData = {
                        action: "addAttendance",
                        name: attendeeName,
                        times: $("input[name='times']:checked").map(function () { return $(this).val(); }).get().join(", "),
                        adults: $("select[name='adults']").val(),
                        kids: $("select[name='kids']").val(),
                        meal: $("input[name='meal']:checked").val(),
                        diet: $("input[name='diet']:checked").val(),
                        message: $("textarea[name='message']").val()
                    };

                    $("#btnSubmitAttendance").prop("disabled", true).text("傳送中...");

                    $.post(GAS_URL, JSON.stringify(formData))
                        .done(function (res) {
                            Swal.fire("感謝填寫!", "期待與你在新家相見!", "success");
                            $("#attendanceForm")[0].reset();
                            // 跳轉到第二個頁籤（活動說明）
                            $('#home-tab').tab('show');
                        })
                        .fail(function () {
                            Swal.fire("Oops...", "傳送失敗，請稍後再試", "error");
                        })
                        .always(function () {
                            $("#btnSubmitAttendance").prop("disabled", false).text("送出確認");
                        });
                }
            });

            // 4. 確認贊助按鈕
            $("#btnConfirmSponsor").click(function () {
                if (!$("#sponsorForm").valid()) return;

                if (!currentUserEmail || !currentUserName) {
                    Swal.fire("請先登入", "請先在首頁登入並填寫您的名字", "warning");
                    return;
                }

                const amount = parseInt($("#sponsorAmount").val());
                const itemId = $("#hiddenItemId").val();
                const itemName = $("#hiddenItemName").val();
                const targetAmount = parseInt($("#modalTarget").data("target"));
                const currentAmount = parseInt($("#modalTarget").data("current"));
                const email = currentUserEmail;
                const name = currentUserName;

                // 計算剩餘可贊助金額
                const remainingAmount = targetAmount - currentAmount;

                // 檢查贊助金額是否超過剩餘金額
                if (amount > remainingAmount) {
                    Swal.fire("金額超過上限", `目前剩餘可贊助金額為 $${remainingAmount}，您輸入的金額超過上限`, "warning");
                    return;
                }

                const payload = {
                    action: "addSponsor",
                    email: email,
                    userName: name,
                    itemId: itemId,
                    itemName: itemName,
                    amount: amount
                };

                $("#btnConfirmSponsor").prop('disabled', true).text("處理中...");

                $.post(GAS_URL, JSON.stringify(payload))
                    .done(function (response) {
                        $('#sponsorModal').modal('hide');
                        Swal.fire("贊助成功!", "謝謝你的心意！", "success");
                        loadShelfItems(); // 重新整理進度
                        if (currentUserEmail) loadMyList(currentUserEmail); // 如果已登入，更新清單
                        // 跳轉到第四個頁籤（我的贊助清單）
                        $('#mylist-tab').tab('show');
                    })
                    .always(function () {
                        $("#btnConfirmSponsor").prop('disabled', false).text("確認贊助");
                    });
            });

            // 5. 儲存使用者名字
            $("#btnSaveName").click(function () {
                const userName = $("#userNameInput").val().trim();
                if (!userName) {
                    Swal.fire("請填寫名字", "請輸入您的稱呼", "warning");
                    return;
                }
                currentUserName = userName;

                // 將資料存入 LocalStorage
                localStorage.setItem("userEmail", currentUserEmail);
                localStorage.setItem("userName", currentUserName);

                $("#name-input-section").hide();
                $("#welcome-section").fadeIn();
                $("#displayUserName").text(userName);
                loadMyList(currentUserEmail);

                // 跳轉到第三個頁籤（集資進度）
                $('#progress-tab').tab('show');
            });

            // 6. 登出按鈕
            $("#btnLogout").click(function () {
                // 清除本地儲存
                localStorage.removeItem("userEmail");
                localStorage.removeItem("userName");

                // 重置變數
                currentUserEmail = "";
                currentUserName = "";

                // 介面復原
                $("#welcome-section").hide();
                $("#name-input-section").hide();
                $("#login-section").fadeIn();
                $(".g_id_signin").show();

                Swal.fire("已登出", "期待您再次回來！", "info");
            });

            // 7. 防止表單按 Enter 造成頁面重整，並將其導向「確認贊助」按鈕
            $("#sponsorForm").on("submit", function (e) {
                e.preventDefault(); // 阻止瀏覽器預設的換頁行為
                $("#btnConfirmSponsor").click(); // 假裝使用者按下了「確認贊助」按鈕
            });

        }); // End Document Ready

        // --- Functions ---

        function loadShelfItems() {
            $.getJSON(GAS_URL, { action: "getItems" }, function (items) {
                const container = $("#shelf-parts-container");
                container.empty();

                items.forEach(item => {
                    const percent = Math.min(100, Math.round((item.current_amount / item.target_amount) * 100));
                    const isFull = percent >= 100;
                    const blinkClass = isFull ? "" : "blinking";
                    const pointerEvent = isFull ? "style='pointer-events:none; opacity:0.8;'" : "";
                    const displayPercent = isFull ? "已達標!" : `${percent}%`;

                    const html = `
                    <div class="part-card ${blinkClass}" ${pointerEvent} 
                         data-id="${item.id}" 
                         data-name="${item.name}" 
                         data-target="${item.target_amount}" 
                         data-current="${item.current_amount}">
                        <img src="${item.image_url}" class="part-img" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                        <div class="progress-badge">${displayPercent}</div>
                        ${isFull ? '<div class="completed-overlay"></div>' : ''}
                    </div>
                `;
                    container.append(html);
                });

                // 綁定點擊事件
                $(".part-card").click(function () {
                    const dataset = $(this).data();
                    const percent = Math.round((dataset.current / dataset.target) * 100);

                    const remainingAmount = dataset.target - dataset.current;

                    $("#modalItemName").text(dataset.name);
                    $("#hiddenItemId").val(dataset.id);
                    $("#hiddenItemName").val(dataset.name);
                    $("#modalTarget").text(`$${dataset.target}`).data("target", dataset.target).data("current", dataset.current);
                    $("#modalRemaining").text(`$${remainingAmount}`);
                    $("#modalProgressBar").css("width", percent + "%").text(percent + "%");
                    $("#modalProgressText").text(`已募集 $${dataset.current} (${percent}%)`);
                    $("#sponsorAmount").val("").attr("max", remainingAmount).attr("placeholder", `最多可贊助 $${remainingAmount}`);

                    $("#sponsorModal").modal("show");
                });
            });
        }

        // Google Login Callback
        function handleCredentialResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);

            currentUserEmail = responsePayload.email;
            // 注意：這裡不先存 userName，等使用者確認名字後才存

            $("#login-section").hide();
            $("#name-input-section").fadeIn();
            $("#userNameInput").val(responsePayload.name || "");
        }

        // 新增：檢查登入狀態
        function checkLoginStatus() {
            const storedEmail = localStorage.getItem("userEmail");
            const storedName = localStorage.getItem("userName");

            if (storedEmail && storedName) {
                console.log("發現舊的登入紀錄，自動登入中...");
                // 更新全域變數
                currentUserEmail = storedEmail;
                currentUserName = storedName;

                // 更新 UI
                $("#login-section").hide();
                $("#name-input-section").hide();
                $("#welcome-section").fadeIn();
                $("#displayUserName").text(storedName);

                // 載入清單
                loadMyList(storedEmail);
            }
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function loadMyList(email) {
            if ($.fn.DataTable.isDataTable('#mySponsorTable')) {
                $('#mySponsorTable').DataTable().destroy();
            }

            $.getJSON(GAS_URL, { action: "getMyList", email: email }, function (data) {
                const tbody = $("#mySponsorTable tbody");
                tbody.empty();

                data.forEach(row => {
                    const date = new Date(row.timestamp).toLocaleDateString();

                    // 判斷狀態顯示什麼文字或圖示
                    // 假設 Google Sheet 裡打勾是 TRUE 或 "TRUE"
                    const isChecked = row.is_checked === true || row.is_checked === "TRUE" || row.is_checked === "V";
                    const statusHtml = isChecked
                        ? '<span class="badge bg-success">已確認</span>'
                        : '<span class="badge bg-secondary">確認中</span>';

                    // 如果已確認，取消按鈕要 disabled
                    const cancelButtonHtml = isChecked
                        ? '<button class="btn btn-sm btn-secondary" disabled>已確認</button>'
                        : `<button class="btn btn-sm btn-danger btn-cancel" 
                                data-id="${row.item_id}" 
                                data-amount="${row.amount}">取消</button>`;

                    const tr = `
                    <tr>
                        <td>${date}</td>
                        <td>${row.item_name}</td>
                        <td>$${row.amount}</td>
                        <td>${statusHtml}</td>
                        <td>${cancelButtonHtml}</td>
                    </tr>
                `;
                    tbody.append(tr);
                });

                // 顯示或隱藏銀行帳戶資訊區塊（贊助筆數大於0時才顯示）
                if (data.length > 0) {
                    $("#bankInfoSection").fadeIn();
                } else {
                    $("#bankInfoSection").hide();
                }

                $('#mySponsorTable').DataTable({
                    "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/zh-HANT.json" }
                });

                // 綁定取消按鈕
                $(".btn-cancel").click(function () {
                    const btn = $(this);
                    const itemId = btn.data("id");
                    const amount = btn.data("amount");

                    Swal.fire({
                        title: '確定取消贊助?',
                        text: "取消後金額將會扣除",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: '是的，取消!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.post(GAS_URL, JSON.stringify({
                                action: "cancelSponsor",
                                email: currentUserEmail,
                                itemId: itemId,
                                amount: amount
                            })).done(function () {
                                Swal.fire("已取消!", "您的贊助已取消。", "success");
                                loadMyList(currentUserEmail);
                                loadShelfItems(); // 更新進度
                            });
                        }
                    });
                });
            });
        }
    </script>

</body>

</html>

